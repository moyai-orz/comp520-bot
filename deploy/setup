#!/usr/bin/env bash

set -euxo pipefail

touch ~/.hushlogin

DOMAIN=$1

hostnamectl set-hostname "$DOMAIN"

apt-get update && apt-get install --yes \
  acl \
  clang \
  libsqlite3-dev \
  libssl-dev \
  pkg-config \
  vim \
  python3-pip

sudo -u bot -s -- bash -c "curl -sSL https://install.python-poetry.org | python3 -"

POETRY_HOME="/home/bot/.local/bin"
echo "export PATH=\"$POETRY_HOME:$PATH\"" | sudo -u bot tee -a /home/bot/.bashrc

if ! id bot &>/dev/null; then
  useradd --system --create-home --home-dir /home/bot --shell /bin/bash bot
fi

mkdir -p /home/bot
chown bot:bot /home/bot
chmod 755 /home/bot

cp -r . /var/lib/bot
chown -R bot:bot /var/lib/bot

sudo -u bot -s -- bash -c "cd /var/lib/bot && /home/bot/.local/bin/poetry install --no-root"

cp deploy/bot.service /etc/systemd/system/

systemctl daemon-reload
systemctl enable bot
systemctl restart bot

echo 'Deployed ðŸŽ‰'
